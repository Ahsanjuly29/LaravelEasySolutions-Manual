
# 🧭 Laravel Event Listeners — Advanced Usage & Scoped Disabling

A professional guide on writing, managing, and controlling Laravel Event Listeners using clean architecture principles (SOLID) and real-world patterns.

---

## 📘 Contents

1. [🎯 Why Use Events & Listeners](#-why-use-events--listeners)
2. [🏗️ Proper Listener Architecture (SOLID)](#-proper-listener-architecture-solid)
3. [⚙️ Registering Events & Listeners](#️-registering-events--listeners)
4. [🚫 Temporarily Disabling Listeners (Scoped)](#-temporarily-disabling-listeners-scoped)
5. [🧪 Testing Events & Listeners](#-testing-events--listeners)
6. [📚 References](#-references)

---

## 🎯 Why Use Events & Listeners?

**Events** help decouple core logic from side effects.

```text
Action (e.g., OrderShipped)
   ↓
Event → Multiple Listeners → Notification, Email, Logging, External API
```

✅ Promotes **Separation of Concerns**
✅ Easier to **extend** (add/remove listeners)
✅ Great for **testing & isolation**

---

## 🏗️ Proper Listener Architecture (SOLID)

Follow **SRP**, **DI**, and clean boundaries.

### 🧩 1. Create Event

```bash
php artisan make:event OrderShipped
```

📄 `App\Events\OrderShipped.php`

```php
class OrderShipped
{
    public function __construct(public Order $order) {}
}
```

### 🧩 2. Create Listener

```bash
php artisan make:listener SendShipmentNotification
```

📄 `App\Listeners\SendShipmentNotification.php`

```php
class SendShipmentNotification
{
    public function __construct(
        private NotificationService $notifier // Inject services, don't use facades directly
    ) {}

    public function handle(OrderShipped $event): void
    {
        $order = $event->order;

        $this->notifier->sendToCustomer(
            $order->user->email,
            'Your order has shipped!',
            view('emails.shipped', compact('order'))->render()
        );
    }
}
```

> 📌 Use injected services, **not static facades**. Improves testability and respects **D**ependency Inversion.

---

## ⚙️ Registering Events & Listeners

📄 `App\Providers\EventServiceProvider.php`

```php
protected $listen = [
    \App\Events\OrderShipped::class => [
        \App\Listeners\SendShipmentNotification::class,
        \App\Listeners\LogOrderShipment::class,
    ],
];
```

✅ Laravel auto-discovers listeners if you use event/listener classes generated by Artisan.

---

## 🚫 Temporarily Disabling Listeners (Scoped)

Sometimes you want to dispatch an event **without triggering some or all listeners**. For example:

* Bulk import
* Seeding
* Controlled logic

### 🔧 SOLUTION: Scoped Disabling with Re-register

#### 📄 `App\Support\EventSilencer.php`

```php
namespace App\Support;

use Illuminate\Support\Facades\Event;

class EventSilencer
{
    protected array $forgotten = [];

    public function without(callable $callback, array $eventsToForget): mixed
    {
        // Backup listeners
        foreach ($eventsToForget as $event => $listeners) {
            $this->forgotten[$event] = Event::getListeners($event);

            foreach ($listeners as $listener) {
                Event::forget($event);
            }
        }

        // Run callback
        $result = $callback();

        // Restore listeners
        foreach ($this->forgotten as $event => $listeners) {
            foreach ($listeners as $listener) {
                Event::listen($event, $listener);
            }
        }

        return $result;
    }
}
```

#### ✅ Usage

```php
use App\Support\EventSilencer;
use App\Events\OrderShipped;
use App\Listeners\SendShipmentNotification;

$silencer = new EventSilencer();

$silencer->without(function () use ($order) {
    event(new OrderShipped($order));
}, [
    OrderShipped::class => [
        SendShipmentNotification::class,
    ]
]);
```

---

## 🧪 Testing Events & Listeners

### ✅ Assert Event Was Dispatched

```php
Event::fake();

event(new OrderShipped($order));

Event::assertDispatched(OrderShipped::class);
```

### ✅ Assert Listener Was Not Run

Use Laravel's `Event::fakeFor()`:

```php
Event::fakeFor(function () use ($order) {
    event(new OrderShipped($order));
});

Event::assertNotDispatched(OrderShipped::class);
```

---

## 🔁 Optional: Globally Disable All Listeners

You can create an Artisan command or global config to conditionally forget multiple listeners (e.g., via `.env`):

```php
if (config('app.disable_event_listeners')) {
    Event::forget(OrderShipped::class);
}
```

---

## 📚 References

* [Laravel Events & Listeners (Docs)](https://laravel.com/docs/events)
* [Service Container & DI in Laravel](https://laravel.com/docs/container)
* [StackOverflow – Temporarily Disabling Listeners](https://stackoverflow.com/q/29407818)

---

## ✅ Summary

| Feature                        | Ready? |
| ------------------------------ | ------ |
| Clean Event-Listener structure | ✅      |
| SOLID-based listener injection | ✅      |
| Scoped listener disabling      | ✅      |
| Testable and reusable          | ✅      |
| Low coupling, high flexibility | ✅      |

> Use events as part of a scalable, maintainable, and decoupled Laravel application structure.

---

Happy coding!
🚀 *Build smarter, not messier.*

```

easy-laravel-events/
├── app/
│   ├── Events/
│   │   └── OrderShipped.php
│   ├── Listeners/
│   │   └── SendShipmentNotification.php
│   ├── Support/
│   │   └── EventSilencer.php
│   └── Services/
│       └── NotificationService.php (dummy placeholder)
├── tests/
│   └── Feature/
│       └── EventListenerTest.php
├── README.md
├── composer.json
└── routes/
    └── web.php
